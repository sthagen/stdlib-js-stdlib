/**
* @license Apache-2.0
*
* Copyright (c) 2018 The Stdlib Authors.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*    http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/

'use strict';

// MODULES //

var basename = require( 'path' ).basename; // TODO: use stdlib module
var extname = require( '@stdlib/utils/extname' );
var indexOf = require( '@stdlib/utils/index-of' );
var lowercase = require( '@stdlib/string/lowercase' );
var EXTENSIONS = require( './extensions.json' );
var SPECIAL = require( './special.json' );


// VARIABLES //

// Only allow alphanumeric characters, `.`, `_`, or `-`:
var BANNED_CHARS = /[^a-zA-Z0-9._-]/; // If this is changed, be sure to update the associated error message


// MAIN //

/**
* Lints an array of filenames.
*
* @private
* @param {StringArray} arr - array of filenames
* @returns {(ObjectArray|EmptyArray)} array of list errors
*/
function lint( arr ) {
	var lower;
	var fname;
	var ext;
	var out;
	var i;

	out = [];
	for ( i = 0; i < arr.length; i++ ) {
		fname = basename( arr[ i ] );
		lower = lowercase( fname );

		// Check that the filename has an allowed extension (if one exists)...
		ext = extname( fname );
		if (
			ext !== '' &&
			indexOf( EXTENSIONS, ext ) === -1
		) {
			out.push({
				'name': arr[ i ],
				'error': 'filename does not have a supported extension name.'
			});
			continue;
		}
		// Remove the extension:
		lower = lower.substring( 0, fname.length-ext.length );

		// Check if the filename is a special case...
		if ( SPECIAL[ lower ] ) {
			if ( SPECIAL[ lower ] !== fname ) {
				out.push({
					'name': arr[ i ],
					'error': 'filename should be `'+SPECIAL[ lower ]+'`.'
				});
			}
			continue;
		}
		// Remove the extension:
		fname = fname.substring( 0, fname.length-ext.length );

		// Check that the filename is lowercase (if not Markdown or a citation file)...
		if (
			ext !== '.md' &&
			ext !== '.cff' &&
			fname !== lower
		) {
			out.push({
				'name': arr[ i ],
				'error': 'filename must be lowercase.'
			});
			continue;
		}
		// Check if the filename contains banned characters...
		if ( BANNED_CHARS.test( fname ) ) {
			out.push({
				'name': arr[ i ],
				'error': 'filename must only contain the following characters: [a-zA-Z0-9._-].'
			});
			continue;
		}
	}
	return out;
}


// EXPORTS //

module.exports = lint;
